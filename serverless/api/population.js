// serverless/api/population.js
export default async function handler(req, res) {
  // GET 요청만 허용
  if (req.method !== "GET") {
    return res.status(405).json({ error: "Method not allowed" });
  }

  try {
    // API 인증키 설정
    const API_KEY = process.env.SEOUL_API_KEY;
    if (!API_KEY) {
      throw new Error("SEOUL_API_KEY 환경 변수가 설정되지 않았습니다.");
    }
    
    // 요청 파라미터 처리
    const { area } = req.query;
    
    // 지역명 매핑 함수
    const mapAreaName = (inputArea) => {
      if (!inputArea) return null;
      
      // 정확한 매핑 테이블 (확장)
      const exactMapping = {
        // 관광특구
        '강남': '강남 MICE 관광특구',
        '강남구': '강남 MICE 관광특구',
        '동대문': '동대문 관광특구',
        '동대문역': '동대문역',
        '명동': '명동 관광특구',
        '이태원': '이태원 관광특구',
        '홍대': '홍대 관광특구',
        '홍익대': '홍대 관광특구',
        '종로': '종로·청계 관광특구',
        '청계': '종로·청계 관광특구',
        '잠실': '잠실 관광특구',
        
        // 역
        '홍대입구역': '홍대입구역(2호선)',
        '홍대입구': '홍대입구역(2호선)',
        '홍대역': '홍대입구역(2호선)',
        
        // 시장
        '동대문 시장': '동대문 관광특구',
        '남대문 시장': '남대문시장',
        '광장 시장': '광장(전통)시장',
        
        // 추가 매핑
        'DDP': 'DDP(동대문디자인플라자)'
      };
      
      // 정확히 일치하는 매핑이 있는지 확인
      if (exactMapping[inputArea]) {
        console.log(`지역명 매핑: ${inputArea} -> ${exactMapping[inputArea]}`);
        return exactMapping[inputArea];
      }
      
      // 정확한 매핑이 없으면 원래 값 사용
      return inputArea;
    };
    
    // 매핑된 지역명 적용
    let requestArea = area ? mapAreaName(area) : '강남 MICE 관광특구'; // 기본값 설정
    
    // API 호출 시도 및 실패 시 재시도 로직
    let apiUrl, response, rawData;
    
    try {
      // 표준 API 요청
      apiUrl = `http://openapi.seoul.go.kr:8088/${API_KEY}/json/citydata_ppltn/1/5/${encodeURIComponent(requestArea)}`;
      console.log(`Trying API call with: "${requestArea}"`);
      
      response = await fetch(apiUrl);
      rawData = await response.json();
      
      // 첫 시도 실패 시 테스트
      if (!rawData["SeoulRtd.citydata_ppltn"] || rawData["SeoulRtd.citydata_ppltn"].length === 0) {
        console.log(`No data found for "${requestArea}", trying alternative...`);
        
        // 괄호 제거 시도
        const cleanedArea = requestArea.replace(/\([^\)]+\)/g, '').trim();
        if (cleanedArea !== requestArea) {
          apiUrl = `http://openapi.seoul.go.kr:8088/${API_KEY}/json/citydata_ppltn/1/5/${encodeURIComponent(cleanedArea)}`;
          console.log(`Retrying with: "${cleanedArea}"`);
          
          response = await fetch(apiUrl);
          rawData = await response.json();
        }
      }
      
      // 여전히 데이터 없으면 "관광특구" 접미사 추가 시도
      if (!rawData["SeoulRtd.citydata_ppltn"] || rawData["SeoulRtd.citydata_ppltn"].length === 0) {
        // 특정 지역명인 경우 관광특구 시도
        const locationKeywords = ['강남', '동대문', '명동', '이태원', '홍대'];
        const matchKeyword = locationKeywords.find(k => requestArea.includes(k));
        
        if (matchKeyword && !requestArea.includes('관광특구')) {
          const touristArea = `${matchKeyword} 관광특구`;
          apiUrl = `http://openapi.seoul.go.kr:8088/${API_KEY}/json/citydata_ppltn/1/5/${encodeURIComponent(touristArea)}`;
          console.log(`Trying with tourist area: "${touristArea}"`);
          
          response = await fetch(apiUrl);
          rawData = await response.json();
        }
      }
      
      // 여전히 데이터 없으면 오류 반환
      if (!rawData["SeoulRtd.citydata_ppltn"] || rawData["SeoulRtd.citydata_ppltn"].length === 0) {
        return res.status(404).json({
          error: "요청한 지역의 데이터를 찾을 수 없습니다",
          message: "정확한 지역명으로 다시 시도해보세요"
        });
      }
    } catch (error) {
      console.error(`API request error: ${error.message}`);
      throw new Error(`서울시 API 요청 중 오류: ${error.message}`);
    }
    
    // API 응답 확인
    if (rawData.RESULT && rawData.RESULT["RESULT.CODE"] !== "INFO-000") {
      throw new Error(`API Error: ${rawData.RESULT["RESULT.MESSAGE"]}`);
    }
    
    // 응답 데이터 구조 변환
    const dataArray = rawData["SeoulRtd.citydata_ppltn"] || [];
    console.log("Data Array Length:", dataArray.length);
    
    const processedData = {
      timestamp: new Date().toISOString(),
      totalCount: dataArray.length,
      places: dataArray.map(place => ({
        id: place.AREA_CD,
        name: place.AREA_NM,
        coordinates: getCoordinatesForPlace(place.AREA_NM, place.AREA_CD),
        congestionLevel: place.AREA_CONGEST_LVL,
        congestionMessage: place.AREA_CONGEST_MSG,
        populationMin: parseInt(place.AREA_PPLTN_MIN || 0),
        populationMax: parseInt(place.AREA_PPLTN_MAX || 0),
        gender: {
          male: parseFloat(place.MALE_PPLTN_RATE || 0),
          female: parseFloat(place.FEMALE_PPLTN_RATE || 0)
        },
        ageGroups: {
          '0': parseFloat(place.PPLTN_RATE_0 || 0),
          '10s': parseFloat(place.PPLTN_RATE_10 || 0),
          '20s': parseFloat(place.PPLTN_RATE_20 || 0),
          '30s': parseFloat(place.PPLTN_RATE_30 || 0),
          '40s': parseFloat(place.PPLTN_RATE_40 || 0),
          '50s': parseFloat(place.PPLTN_RATE_50 || 0),
          '60s': parseFloat(place.PPLTN_RATE_60 || 0),
          '70s': parseFloat(place.PPLTN_RATE_70 || 0)
        },
        updatedAt: place.PPLTN_TIME,
        hasForecast: place.FCST_YN === "Y"
      }))
    };
    
    // 데이터 반환
    res.status(200).json(processedData);
  } catch (error) {
    console.error("Error fetching population data:", error);
    console.error("Error stack:", error.stack);
    res.status(500).json({ 
      error: "서울시 인구 데이터를 불러오는 중 오류가 발생했습니다.",
      message: error.message,
      stack: process.env.NODE_ENV === 'development' ? error.stack : undefined,
      time: new Date().toISOString()
    });
  }
}

// 모든 지역에 대한 좌표 데이터
function getCoordinatesForPlace(placeName, placeCode) {
  // 모든 지역의 좌표 데이터
  const placeCoordinates = {
    // 관광특구
    'POI001': [37.5065, 127.0617], // 강남 MICE 관광특구
    '강남 MICE 관광특구': [37.5065, 127.0617],
    'POI002': [37.5655, 127.0077], // 동대문 관광특구
    '동대문 관광특구': [37.5655, 127.0077],
    '동대문역': [37.5710, 127.0097],
    'POI003': [37.5634, 126.9830], // 명동 관광특구
    '명동 관광특구': [37.5634, 126.9830],
    'POI004': [37.5347, 126.9941], // 이태원 관광특구
    '이태원 관광특구': [37.5347, 126.9941],
    'POI005': [37.5132, 127.1001], // 잠실 관광특구
    '잠실 관광특구': [37.5132, 127.1001],
    'POI006': [37.5704, 126.9922], // 종로·청계 관광특구
    '종로·청계 관광특구': [37.5704, 126.9922],
    'POI007': [37.5552, 126.9206], // 홍대 관광특구
    '홍대 관광특구': [37.5552, 126.9206],
    
    // 고궁·문화유산
    'POI008': [37.5769, 126.9769], // 경복궁
    '경복궁': [37.5769, 126.9769],
    'POI009': [37.5725, 126.9769], // 광화문·덕수궁
    '광화문·덕수궁': [37.5725, 126.9769],
    'POI010': [37.5695, 126.9837], // 보신각
    '보신각': [37.5695, 126.9837],
    'POI011': [37.5570, 127.1279], // 서울 암사동 유적
    '서울 암사동 유적': [37.5570, 127.1279],
    'POI012': [37.5792, 126.9911], // 창덕궁·종묘
    '창덕궁·종묘': [37.5792, 126.9911],
    
    // 인구밀집지역 (역)
    'POI013': [37.4819, 126.8822], // 가산디지털단지역
    '가산디지털단지역': [37.4819, 126.8822],
    'POI014': [37.4982, 127.0279], // 강남역
    '강남역': [37.4982, 127.0279],
    'POI015': [37.5407, 127.0694], // 건대입구역
    '건대입구역': [37.5407, 127.0694],
    'POI016': [37.5546, 127.1544], // 고덕역
    '고덕역': [37.5546, 127.1544],
    'POI017': [37.5046, 127.0047], // 고속터미널역
    '고속터미널역': [37.5046, 127.0047],
    'POI018': [37.4935, 127.0142], // 교대역
    '교대역': [37.4935, 127.0142],
    'POI019': [37.4858, 126.9014], // 구로디지털단지역
    '구로디지털단지역': [37.4858, 126.9014],
    'POI020': [37.5033, 126.8819], // 구로역
    '구로역': [37.5033, 126.8819],
    'POI021': [37.5572, 127.0793], // 군자역
    '군자역': [37.5572, 127.0793],
    'POI023': [37.4913, 126.8953], // 대림역
    '대림역': [37.4913, 126.8953],
    'POI024': [37.5710, 127.0097], // 동대문역
    '동대문역': [37.5710, 127.0097],
    'POI025': [37.5474, 127.0474], // 뚝섬역
    '뚝섬역': [37.5474, 127.0474],
    'POI026': [37.6134, 127.0300], // 미아사거리역
    '미아사거리역': [37.6134, 127.0300],
    'POI027': [37.5581, 126.8387], // 발산역
    '발산역': [37.5581, 126.8387],
    'POI029': [37.4766, 126.9816], // 사당역
    '사당역': [37.4766, 126.9816],
    'POI030': [37.5344, 126.9729], // 삼각지역
    '삼각지역': [37.5344, 126.9729],
    'POI031': [37.4813, 126.9524], // 서울대입구역
    '서울대입구역': [37.4813, 126.9524],
    'POI032': [37.5669, 126.8275], // 서울식물원·마곡나루역
    '서울식물원·마곡나루역': [37.5669, 126.8275],
    'POI033': [37.5561, 126.9715], // 서울역
    '서울역': [37.5561, 126.9715],
    'POI034': [37.5045, 127.0486], // 선릉역
    '선릉역': [37.5045, 127.0486],
    'POI035': [37.5926, 127.0163], // 성신여대입구역
    '성신여대입구역': [37.5926, 127.0163],
    'POI036': [37.6366, 127.0256], // 수유역
    '수유역': [37.6366, 127.0256],
    'POI037': [37.5045, 127.0215], // 신논현역·논현역
    '신논현역·논현역': [37.5045, 127.0215],
    'POI038': [37.5090, 126.8912], // 신도림역
    '신도림역': [37.5090, 126.8912],
    'POI039': [37.4840, 126.9295], // 신림역
    '신림역': [37.4840, 126.9295],
    'POI040': [37.5568, 126.9421], // 신촌·이대역
    '신촌·이대역': [37.5568, 126.9421],
    'POI041': [37.4847, 127.0346], // 양재역
    '양재역': [37.4847, 127.0346],
    'POI042': [37.5008, 127.0362], // 역삼역
    '역삼역': [37.5008, 127.0362],
    'POI043': [37.6191, 126.9212], // 연신내역
    '연신내역': [37.6191, 126.9212],
    'POI044': [37.5245, 126.8757], // 오목교역·목동운동장
    '오목교역·목동운동장': [37.5245, 126.8757],
    'POI045': [37.5615, 127.0370], // 왕십리역
    '왕십리역': [37.5615, 127.0370],
    'POI046': [37.5301, 126.9651], // 용산역
    '용산역': [37.5301, 126.9651],
    'POI047': [37.5347, 126.9941], // 이태원역
    '이태원역': [37.5347, 126.9941],
    'POI048': [37.4794, 127.1270], // 장지역
    '장지역': [37.4794, 127.1270],
    'POI049': [37.5614, 127.0645], // 장한평역
    '장한평역': [37.5614, 127.0645],
    'POI050': [37.5390, 127.1234], // 천호역
    '천호역': [37.5390, 127.1234],
    'POI051': [37.4864, 126.9821], // 총신대입구(이수)역
    '총신대입구(이수)역': [37.4864, 126.9821],
    'POI052': [37.5599, 126.9637], // 충정로역
    '충정로역': [37.5599, 126.9637],
    'POI053': [37.5500, 126.9136], // 합정역
    '합정역': [37.5500, 126.9136],
    'POI054': [37.5820, 127.0016], // 혜화역
    '혜화역': [37.5820, 127.0016],
    'POI055': [37.5574, 126.9245], // 홍대입구역(2호선)
    '홍대입구역(2호선)': [37.5574, 126.9245],
    'POI056': [37.5899, 127.0568], // 회기역
    '회기역': [37.5899, 127.0568],
    'POI070': [37.6489, 127.0348], // 쌍문역
    '쌍문역': [37.6489, 127.0348],
    'POI117': [37.5123, 126.8532], // 신정네거리역
    '신정네거리역': [37.5123, 126.8532],
    'POI118': [37.5113, 127.0861], // 잠실새내역
    '잠실새내역': [37.5113, 127.0861],
    'POI119': [37.5132, 127.1001], // 잠실역
    '잠실역': [37.5132, 127.1001],
    
    // 발달상권
    'POI058': [37.4934, 127.1185], // 가락시장
    '가락시장': [37.4934, 127.1185],
    'POI059': [37.5218, 127.0232], // 가로수길
    '가로수길': [37.5218, 127.0232],
    'POI060': [37.5350, 127.0912], // 광장(전통)시장
    '광장(전통)시장': [37.5350, 127.0912],
    'POI061': [37.5583, 126.8024], // 김포공항
    '김포공항': [37.5583, 126.8024],
    'POI063': [37.5132, 126.9421], // 노량진
    '노량진': [37.5132, 126.9421],
    'POI064': [37.5652, 126.9744], // 덕수궁길·정동길
    '덕수궁길·정동길': [37.5652, 126.9744],
    'POI066': [37.5811, 126.9846], // 북촌한옥마을
    '북촌한옥마을': [37.5811, 126.9846],
    'POI067': [37.5790, 126.9710], // 서촌
    '서촌': [37.5790, 126.9710],
    'POI068': [37.5466, 127.0476], // 성수카페거리
    '성수카페거리': [37.5466, 127.0476],
    'POI071': [37.5274, 127.0388], // 압구정로데오거리
    '압구정로데오거리': [37.5274, 127.0388],
    'POI072': [37.5249, 126.9237], // 여의도
    '여의도': [37.5249, 126.9237],
    'POI073': [37.5626, 126.9252], // 연남동
    '연남동': [37.5626, 126.9252],
    'POI074': [37.5172, 126.9033], // 영등포 타임스퀘어
    '영등포 타임스퀘어': [37.5172, 126.9033],
    'POI076': [37.5320, 126.9654], // 용리단길
    '용리단길': [37.5320, 126.9654],
    'POI077': [37.5340, 126.9933], // 이태원 앤틱가구거리
    '이태원 앤틱가구거리': [37.5340, 126.9933],
    'POI078': [37.5744, 126.9856], // 인사동
    '인사동': [37.5744, 126.9856],
    'POI079': [37.6540, 127.0495], // 창동 신경제 중심지
    '창동 신경제 중심지': [37.6540, 127.0495],
    'POI080': [37.5240, 127.0531], // 청담동 명품거리
    '청담동 명품거리': [37.5240, 127.0531],
    'POI081': [37.5802, 127.0377], // 청량리 제기동 일대 전통시장
    '청량리 제기동 일대 전통시장': [37.5802, 127.0377],
    'POI082': [37.5381, 126.9911], // 해방촌·경리단길
    '해방촌·경리단길': [37.5381, 126.9911],
    'POI083': [37.5676, 127.0093], // DDP(동대문디자인플라자)
    'DDP(동대문디자인플라자)': [37.5676, 127.0093],
    'POI084': [37.5812, 126.8928], // DMC(디지털미디어시티)
    'DMC(디지털미디어시티)': [37.5812, 126.8928],
    'POI114': [37.5638, 126.9775], // 북창동 먹자골목
    '북창동 먹자골목': [37.5638, 126.9775],
    'POI115': [37.5592, 126.9777], // 남대문시장
    '남대문시장': [37.5592, 126.9777],
    'POI116': [37.5741, 126.9883], // 익선동
    '익선동': [37.5741, 126.9883],
    'POI120': [37.5123, 127.1025], // 잠실롯데타워 일대
    '잠실롯데타워 일대': [37.5123, 127.1025],
    'POI121': [37.5168, 127.0979], // 송리단길·호수단길
    '송리단길·호수단길': [37.5168, 127.0979],
    'POI122': [37.5567, 126.9367], // 신촌 스타광장
    '신촌 스타광장': [37.5567, 126.9367],
    
    // 공원
    'POI085': [37.5881, 126.8170], // 강서한강공원
    '강서한강공원': [37.5881, 126.8170],
    'POI086': [37.4982, 126.8668], // 고척돔
    '고척돔': [37.4982, 126.8668],
    'POI087': [37.5452, 127.1203], // 광나루한강공원
    '광나루한강공원': [37.5452, 127.1203],
    'POI088': [37.5725, 126.9769], // 광화문광장
    '광화문광장': [37.5725, 126.9769],
    'POI089': [37.5240, 126.9800], // 국립중앙박물관·용산가족공원
    '국립중앙박물관·용산가족공원': [37.5240, 126.9800],
    'POI090': [37.5623, 126.8775], // 난지한강공원
    '난지한강공원': [37.5623, 126.8775],
    'POI091': [37.5512, 126.9882], // 남산공원
    '남산공원': [37.5512, 126.9882],
    'POI092': [37.5175, 126.9567], // 노들섬
    '노들섬': [37.5175, 126.9567],
    'POI093': [37.5290, 127.0686], // 뚝섬한강공원
    '뚝섬한강공원': [37.5290, 127.0686],
    'POI094': [37.5504, 126.9013], // 망원한강공원
    '망원한강공원': [37.5504, 126.9013],
    'POI095': [37.5102, 126.9973], // 반포한강공원
    '반포한강공원': [37.5102, 126.9973],
    'POI096': [37.6206, 127.0414], // 북서울꿈의숲
    '북서울꿈의숲': [37.6206, 127.0414],
    'POI098': [37.4831, 127.0078], // 서리풀공원·몽마르뜨공원
    '서리풀공원·몽마르뜨공원': [37.4831, 127.0078],
    'POI099': [37.5651, 126.9782], // 서울광장
    '서울광장': [37.5651, 126.9782],
    'POI100': [37.4273, 127.0165], // 서울대공원
    '서울대공원': [37.4273, 127.0165],
    'POI101': [37.5443, 127.0379], // 서울숲공원
    '서울숲공원': [37.5443, 127.0379],
    'POI102': [37.5658, 127.1059], // 아차산
    '아차산': [37.5658, 127.1059],
    'POI103': [37.5461, 126.8968], // 양화한강공원
    '양화한강공원': [37.5461, 126.8968],
    'POI104': [37.5491, 127.0748], // 어린이대공원
    '어린이대공원': [37.5491, 127.0748],
    'POI105': [37.5283, 126.9317], // 여의도한강공원
    '여의도한강공원': [37.5283, 126.9317],
    'POI106': [37.5684, 126.8829], // 월드컵공원
    '월드컵공원': [37.5684, 126.8829],
    'POI107': [37.5489, 127.0316], // 응봉산
    '응봉산': [37.5489, 127.0316],
    'POI108': [37.5203, 126.9664], // 이촌한강공원
    '이촌한강공원': [37.5203, 126.9664],
    'POI109': [37.5140, 127.0734], // 잠실종합운동장
    '잠실종합운동장': [37.5140, 127.0734],
    'POI110': [37.5167, 127.0932], // 잠실한강공원
    '잠실한강공원': [37.5167, 127.0932],
    'POI111': [37.5148, 127.0119], // 잠원한강공원
    '잠원한강공원': [37.5148, 127.0119],
    'POI112': [37.4239, 127.0562], // 청계산
    '청계산': [37.4239, 127.0562],
    'POI113': [37.5866, 126.9777], // 청와대
    '청와대': [37.5866, 126.9777],
    'POI123': [37.4931, 126.9195], // 보라매공원
    '보라매공원': [37.4931, 126.9195],
    'POI124': [37.5723, 126.9601], // 서대문독립공원
    '서대문독립공원': [37.5723, 126.9601],
    'POI125': [37.5171, 126.8904], // 안양천
    '안양천': [37.5171, 126.8904],
    'POI126': [37.5264, 126.9197], // 여의서로
    '여의서로': [37.5264, 126.9197],
    'POI127': [37.5221, 127.1214], // 올림픽공원
    '올림픽공원': [37.5221, 127.1214],
    'POI128': [37.5954, 126.9507], // 홍제폭포
    '홍제폭포': [37.5954, 126.9507],
    
    // 기본 좌표 (서울 시청)
    'default': [37.5665, 126.9780]
  };
  
  // 코드로 찾기 (코드 기준 매핑이 있는 경우)
  if (placeCode && placeCoordinates[placeCode]) {
    return placeCoordinates[placeCode];
  }
  
  // 이름으로 찾기
  if (placeName && placeCoordinates[placeName]) {
    return placeCoordinates[placeName];
  }
  
  // 이름이나 코드로 찾지 못한 경우 로그 출력
  if (placeCode || placeName) {
    console.log(`지역 좌표 정보 없음 - 코드: ${placeCode}, 이름: ${placeName}`);
  }
  
  // 이전처럼 랜덤 생성하는 대신 가까운 좌표로 대체
  // 임의의 큰 오프셋 대신 더 작은 범위 내에서 약간의 변동만 주기
  const seoulCenter = placeCoordinates['default'];
  const smallRandomOffset = () => (Math.random() - 0.5) * 0.01; // ±0.005도 (약 500m)
  
  return [
    seoulCenter[0] + smallRandomOffset(),
    seoulCenter[1] + smallRandomOffset()
  ];
}